# **üèóÔ∏è ARQUITETURA DEFINITIVA - SIGNAL DETECTOR**

## **üìÅ ESTRUTURA DE PASTAS**

```
signal-detector/
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ signal-processor/          # Microservi√ßo 1
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SignalClassifier.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ VoiceProcessor.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ .env
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ accountability-engine/      # Microservi√ßo 2
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PNLCoach.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PatternAnalyzer.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ .env
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ shared/
‚îÇ       ‚îú‚îÄ‚îÄ database/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ schema.sql
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ signal.db            # SQLite √∫nico
‚îÇ       ‚îî‚îÄ‚îÄ utils/
‚îÇ
‚îú‚îÄ‚îÄ frontend/                       # PWA
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ next.config.js
‚îÇ
‚îî‚îÄ‚îÄ README.md
```

---

## **üíæ SCHEMA SQLite UNIFICADO**

```sql
-- services/shared/database/schema.sql

-- ===============================
-- CORE TABLES
-- ===============================

CREATE TABLE users (
  id TEXT PRIMARY KEY DEFAULT (hex(randomblob(16))),
  email TEXT UNIQUE NOT NULL,
  name TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE goals (
  id TEXT PRIMARY KEY DEFAULT (hex(randomblob(16))),
  user_id TEXT REFERENCES users(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  target_value REAL DEFAULT 0,
  current_value REAL DEFAULT 0,
  is_active BOOLEAN DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- ===============================
-- CORE FEATURE 1: SIGNAL CLASSIFICATION
-- ===============================

CREATE TABLE activities (
  id TEXT PRIMARY KEY DEFAULT (hex(randomblob(16))),
  user_id TEXT REFERENCES users(id) ON DELETE CASCADE,
  
  -- Input Data
  description TEXT NOT NULL,
  duration_minutes INTEGER,
  energy_before INTEGER CHECK (energy_before BETWEEN 1 AND 10),
  energy_after INTEGER CHECK (energy_after BETWEEN 1 AND 10),
  
  -- CORE: Signal Classification
  signal_score INTEGER CHECK (signal_score BETWEEN 0 AND 100),
  classification TEXT CHECK (classification IN ('SINAL', 'RU√çDO', 'NEUTRO')),
  confidence_score REAL CHECK (confidence_score BETWEEN 0 AND 1),
  reasoning TEXT,
  classification_method TEXT, -- 'rules', 'ai', 'manual'
  
  -- Voice Support
  voice_file_path TEXT,
  transcription TEXT,
  
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- ===============================
-- CORE FEATURE 2: ACCOUNTABILITY COACHING
-- ===============================

CREATE TABLE coaching_sessions (
  id TEXT PRIMARY KEY DEFAULT (hex(randomblob(16))),
  user_id TEXT REFERENCES users(id) ON DELETE CASCADE,
  
  -- PNL Coaching Core
  nlp_technique TEXT NOT NULL, -- 'modal_operator_challenge', 'generalization_challenge', etc
  coaching_question TEXT NOT NULL,
  user_response TEXT,
  
  -- Outcomes
  insights_generated TEXT, -- JSON array como string
  breakthrough_detected BOOLEAN DEFAULT 0,
  user_satisfaction INTEGER CHECK (user_satisfaction BETWEEN 1 AND 10),
  
  -- Follow-up
  next_session_recommended DATETIME,
  
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- ===============================
-- PATTERN DETECTION (Support)
-- ===============================

CREATE TABLE user_patterns (
  id TEXT PRIMARY KEY DEFAULT (hex(randomblob(16))),
  user_id TEXT REFERENCES users(id) ON DELETE CASCADE,
  
  pattern_type TEXT, -- 'procrastination', 'perfectionism', 'scattered_focus'
  confidence_score REAL CHECK (confidence_score BETWEEN 0 AND 1),
  detected_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  -- Supporting data as JSON string
  supporting_data TEXT
);

-- ===============================
-- ANALYTICS CACHE
-- ===============================

CREATE TABLE analytics_cache (
  id TEXT PRIMARY KEY DEFAULT (hex(randomblob(16))),
  user_id TEXT REFERENCES users(id) ON DELETE CASCADE,
  
  cache_key TEXT NOT NULL,
  cache_data TEXT NOT NULL, -- JSON string
  expires_at DATETIME NOT NULL,
  
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- ===============================
-- INDEXES FOR PERFORMANCE
-- ===============================

CREATE INDEX idx_activities_user_date ON activities(user_id, created_at DESC);
CREATE INDEX idx_activities_signal_score ON activities(user_id, signal_score DESC);
CREATE INDEX idx_coaching_sessions_user ON coaching_sessions(user_id, created_at DESC);
CREATE INDEX idx_user_patterns_type ON user_patterns(user_id, pattern_type);
CREATE INDEX idx_analytics_cache_key ON analytics_cache(user_id, cache_key);
```

---

## **üß† JEITO DE PENSAR DEFINITIVO**

### **1. Signal Processor (Porto 4000)**
```javascript
// services/signal-processor/src/services/SignalClassifier.js

class SignalClassifier {
  
  // LAYER 1: Regras baseadas em primeiros princ√≠pios
  classifyByRules(activity) {
    let score = 50; // Neutro
    let reasoning = [];

    // REGRA 1: Avan√ßa objetivos espec√≠ficos? (+30)
    if (this.advancesGoals(activity)) {
      score += 30;
      reasoning.push("Avan√ßa objetivos espec√≠ficos");
    }

    // REGRA 2: Energia crescente? (+20) 
    if (activity.energyAfter > activity.energyBefore) {
      score += 20;
      reasoning.push("Aumentou energia");
    }

    // REGRA 3: Alto impacto, baixo tempo? (+20)
    if (activity.duration < 60 && this.isHighImpact(activity)) {
      score += 20;
      reasoning.push("Alto leverage");
    }

    // REGRA 4: Atividades de ru√≠do conhecidas (-40)
    if (this.isKnownDistraction(activity)) {
      score -= 40;
      reasoning.push("Distra√ß√£o identificada");
    }

    return {
      score: Math.max(0, Math.min(100, score)),
      classification: score > 70 ? 'SINAL' : score < 40 ? 'RU√çDO' : 'NEUTRO',
      confidence: reasoning.length > 2 ? 0.8 : 0.5,
      reasoning: reasoning.join('; '),
      method: 'rules'
    };
  }

  // LAYER 2: OpenAI para casos duvidosos
  async classifyWithAI(activity) {
    const prompt = `
    Classifique como SINAL (avan√ßa objetivos) ou RU√çDO (distra√ß√£o):
    
    Atividade: "${activity.description}"
    Dura√ß√£o: ${activity.duration}min
    Energia: ${activity.energyBefore} ‚Üí ${activity.energyAfter}
    
    Responda JSON: {"score": 0-100, "reasoning": "explica√ß√£o breve"}
    `;

    // Implementar chamada OpenAI
    const response = await this.openai.complete(prompt);
    return JSON.parse(response);
  }
}
```

### **2. Accountability Engine (Porto 5000)**
```javascript
// services/accountability-engine/src/services/PNLCoach.js

class PNLCoach {
  
  generateCoachingQuestion(userPatterns) {
    // Detecta padr√£o dominante
    const dominantPattern = this.identifyDominantPattern(userPatterns);
    
    // Seleciona t√©cnica PNL
    const nlpTechnique = this.selectNLPTechnique(dominantPattern);
    
    // Gera pergunta personalizada
    const question = this.craftQuestion(nlpTechnique, userPatterns);
    
    return {
      nlpTechnique,
      question,
      expectedOutcome: this.predictOutcome(nlpTechnique)
    };
  }

  selectNLPTechnique(pattern) {
    const techniqueMap = {
      'procrastination': 'modal_operator_challenge', // "n√£o posso" ‚Üí "o que aconteceria se..."
      'perfectionism': 'generalization_challenge',   // "sempre" ‚Üí "sempre mesmo?"
      'scattered_focus': 'outcome_specification',    // "qual exatamente o resultado?"
      'self_sabotage': 'deletion_challenge'          // "o que voc√™ est√° omitindo?"
    };
    
    return techniqueMap[pattern] || 'open_inquiry';
  }

  craftQuestion(technique, userPatterns) {
    const templates = {
      modal_operator_challenge: [
        "O que especificamente te impede de {goal}?",
        "O que aconteceria se voc√™ realmente {action}?",
        "Quem disse que voc√™ deve {pattern}?"
      ],
      generalization_challenge: [
        "Sempre procrastina em {area}? Alguma exce√ß√£o?",
        "Nunca consegue {behavior}? Houve algum per√≠odo que funcionou?"
      ],
      outcome_specification: [
        "Qual especificamente seria o resultado ideal?",
        "Como voc√™ saberia que alcan√ßou sucesso?"
      ]
    };

    // Personalizar com dados do usu√°rio
    return this.personalizeTemplate(templates[technique], userPatterns);
  }
}
```

### **3. Analytics Essenciais**
```javascript
// Insights acion√°veis (n√£o apenas n√∫meros)
class AdvancedAnalytics {
  
  generateInsights(userId) {
    return {
      // Padr√µes temporais
      bestProductiveHours: "Voc√™ √© 73% mais produtivo √†s 9h",
      worstProductiveHours: "Evite tarefas complexas √†s 15h",
      
      // Correla√ß√µes energia x atividade
      energyPatterns: "Exerc√≠cio aumenta signal score em 25%",
      
      // Otimiza√ß√µes de agenda
      recommendations: [
        "Mover 'Review c√≥digo' para 10h (+15 pontos)",
        "Reduzir reuni√µes > 60min (-40% ru√≠do)"
      ],
      
      // Previs√µes comportamentais
      predictions: "80% chance de procrastinar esta tarde"
    };
  }
}
```

---

## **üöÄ COMANDOS DE INICIALIZA√á√ÉO**

```bash
# Terminal 1 - Signal Processor
cd services/signal-processor
npm install
npm start # Porta 4000

# Terminal 2 - Accountability Engine  
cd services/accountability-engine
npm install
npm start # Porta 5000

# Terminal 3 - Frontend
cd frontend
npm install
npm run dev # Porta 3000
```

---

## **üéØ PRIORIDADES DE DESENVOLVIMENTO**

### **SEMANA 1:**
1. Setup b√°sico dos 3 services
2. SQLite + schema implementado
3. SignalClassifier com regras hardcoded
4. Voice recording no frontend

### **SEMANA 2:**
1. PNL Coach com templates b√°sicos
2. OpenAI integration para casos duvidosos
3. Dashboard com analytics simples
4. Pipeline voice ‚Üí transcription ‚Üí activity

### **SEMANA 3:**
1. Pattern detection autom√°tico
2. Coaching sessions automatizadas
3. Analytics avan√ßados (insights)
4. PWA features (offline, notifications)

### **SEMANA 4:**
1. Fine-tuning com dados reais
2. Deploy production
3. Feedback loop e itera√ß√£o
4. Prepara√ß√£o para uso pessoal

**FOCO: Features core funcionando perfeitamente antes de qualquer feature secund√°ria.**